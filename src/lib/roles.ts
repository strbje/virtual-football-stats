// src/lib/roles.ts

/** Группа амплуа для агрегирования в барчарт */
export type RoleGroup =
  | 'ФРВ'  // форварды: ФРВ, ЦФД, ЛФД, ПФД, ЛФА, ПФА
  | 'ЦАП'  // атакующий полузащитник: ЦАП
  | 'КП'   // крайние полузащитники: ЛАП, ПАП, ЛП, ПП
  | 'ЦП'   // центральные полузащитники: ЦП, ЛПЦ, ПЦП
  | 'ЦОП'  // опорные полузащитники: ЦОП, ЛОП, ПОП
  | 'ЦЗ'   // центральные защитники: ЦЗ, ЛЦЗ, ПЦЗ
  | 'КЗ'   // крайние защитники: ЛЗ, ПЗ (и общий КЗ)
  | 'ВРТ'; // вратарь

/** Маппинг каждого кода позиции в агрегированную группу */
export const ROLE_TO_GROUP: Record<string, RoleGroup> = {
  // Защита (центральные)
  'ЦЗ': 'ЦЗ', 'ЛЦЗ': 'ЦЗ', 'ПЦЗ': 'ЦЗ',
  // Вратарь
  'ВРТ': 'ВРТ',
  // Защита (крайние)
  'КЗ': 'КЗ', 'ЛЗ': 'КЗ', 'ПЗ': 'КЗ',
  // Опорники
  'ЦОП': 'ЦОП', 'ЛОП': 'ЦОП', 'ПОП': 'ЦОП',
  // Центральные полузащитники
  'ЦП': 'ЦП', 'ЛПЦ': 'ЦП', 'ПЦП': 'ЦП',
  // Крайние полузащитники
  'КП': 'КП', 'ЛАП': 'КП', 'ПАП': 'КП', 'ЛП': 'КП', 'ПП': 'КП',
  // Атакующий полузащитник
  'ЦАП': 'ЦАП',
  // Форварды (все вариации идут в одну группу)
  'ФРВ': 'ФРВ', 'ЦФД': 'ФРВ', 'ЛФД': 'ФРВ', 'ПФД': 'ФРВ', 'ЛФА': 'ФРВ', 'ПФА': 'ФРВ',
};

/** Подписи групп для барчарта (полные названия) */
export const GROUP_LABELS: Record<RoleGroup, string> = {
  'ФРВ': 'Форвард',
  'ЦАП': 'Атакующий полузащитник',
  'КП' : 'Крайний полузащитник',
  'ЦП' : 'Центральный полузащитник',
  'ЦОП': 'Опорный полузащитник',
  'ЦЗ' : 'Центральный защитник',
  'КЗ' : 'Крайний защитник',
  'ВРТ': 'Вратарь',
};

/** Исходные проценты по конкретным кодам амплуа (для теплокарты и агрегации) */
export type RolePercent = { role: string; percent: number };

/** Агрегированный результат по группам для барчарта */
export type GroupPercent = { group: RoleGroup; percent: number };

/** Агрегация процентов по группам с сортировкой по убыванию */
export function groupRolePercents(raw: RolePercent[]): GroupPercent[] {
  const acc = new Map<RoleGroup, number>();

  for (const item of raw ?? []) {
    const code = (item.role || '').toUpperCase().trim();
    const group = ROLE_TO_GROUP[code];
    if (!group) continue; // неизвестные коды игнорим
    acc.set(group, (acc.get(group) ?? 0) + (item.percent ?? 0));
  }

  return Array.from(acc.entries())
    .map(([group, percent]) => ({ group, percent }))
    .sort((a, b) => b.percent - a.percent);
}

/**
 * Координаты точек для теплокарты (проценты считаются снаружи, здесь — только геометрия).
 * Используется ТОЛЬКО как справочник; что рисовать — решает компонент (фильтрует 0).
 */
export const ROLE_COORDS: Record<string, { x: number; y: number }> = {
  // Вратарь
  'ВРТ': { x: 50, y: 5 },

  // Линия защитников
  'ЛЗ' : { x: 20, y: 22 },
  'ЛЦЗ': { x: 38, y: 18 },
  'ЦЗ' : { x: 50, y: 18 },
  'ПЦЗ': { x: 62, y: 18 },
  'ПЗ' : { x: 80, y: 22 },
  'КЗ' : { x: 50, y: 22 }, // общий ярлык для случаев без уточнения стороны

  // Опорники
  'ЛОП': { x: 40, y: 35 },
  'ЦОП': { x: 50, y: 35 },
  'ПОП': { x: 60, y: 35 },

  // Центральные полузащитники
  'ЛПЦ': { x: 40, y: 50 },
  'ЦП' : { x: 50, y: 50 },
  'ПЦП': { x: 60, y: 50 },

  // Крайние полузащитники (ширина)
  'ЛП' : { x: 25, y: 56 },
  'ПП' : { x: 75, y: 56 },

  // АПЗ / «десятки»
  'ЛАП': { x: 38, y: 62 },
  'ЦАП': { x: 50, y: 62 },
  'ПАП': { x: 62, y: 62 },

  // Атака
  'ЛФА': { x: 40, y: 78 },
  'ЛФД': { x: 40, y: 78 },
  'ФРВ': { x: 50, y: 78 },
  'ЦФД': { x: 50, y: 78 },
  'ПФА': { x: 60, y: 78 },
  'ПФД': { x: 60, y: 78 },
};
