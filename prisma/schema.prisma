// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role { GK CB LB RB CDM CM CAM LW RW ST }
enum MatchStatus { planned played }

model Player {
  id                 String   @id @default(uuid())
  gamertag           String
  platform           String
  contactTelegram    String?
  contactDiscord     String?
  preferredRoles     String
  primaryRole        Role?
  availability       String?
  mic                Boolean  @default(true)
  isCaptainCandidate Boolean  @default(false)
  ratingInit         Float    @default(0)
  reputationInit     Int      @default(50)
  createdAt          DateTime @default(now())

  teamMembers        TeamMember[]
  draftPicks         DraftPick[]
  lineups            Lineup[]
  reputationEvents   ReputationEvent[]
}

model DraftSession {
  id            String   @id @default(uuid())
  name          String
  status        String   @default("planned") // planned | live | finished
  snake         Boolean  @default(true)
  forceGkRound  Int      @default(3)
  createdAt     DateTime @default(now())

  teams         Team[]
  picks         DraftPick[]
  matches       Match[]
  turns         DraftTurn?
}

model Team {
  id           String   @id @default(uuid())
  sessionId    String?
  name         String
  color        String?
  captainId    String?
  draftOrder   Int?
  createdAt    DateTime @default(now())

  session      DraftSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  captain      Player?       @relation(fields: [captainId], references: [id])
  members      TeamMember[]
  homeMatches  Match[]       @relation("homeTeam")
  awayMatches  Match[]       @relation("awayTeam")

  @@unique([sessionId, name])
}

model TeamMember {
  teamId       String
  playerId     String
  roleAtSignup Role?
  joinedAt     DateTime @default(now())
  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@id([teamId, playerId])
}

model DraftPick {
  id          String   @id @default(uuid())
  sessionId   String
  round       Int
  pickOverall Int
  teamId      String
  playerId    String
  isAutopick  Boolean  @default(false)
  comment     String?
  madeAt      DateTime @default(now())

  session     DraftSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  team        Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player      Player       @relation(fields: [playerId], references: [id])

  @@unique([sessionId, pickOverall])
  @@unique([sessionId, playerId])
}

model DraftTurn {
  sessionId    String   @id
  currentRound Int      @default(1)
  pickInRound  Int      @default(1)
  pickDeadline DateTime?
  isReversed   Boolean  @default(false)
  session      DraftSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Match {
  id           String   @id @default(uuid())
  sessionId    String
  round        Int
  slot         Int
  homeTeamId   String
  awayTeamId   String
  homeGoals    Int?
  awayGoals    Int?
  status       MatchStatus @defa
